name: Veracode Static Analysis Pipeline Scan

# üöÄ Quando esse workflow ser√° executado?
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '41 2 * * 0'

# üîê Permiss√µes b√°sicas para acessar o reposit√≥rio e criar alertas de seguran√ßa
permissions:
  contents: read

jobs:
  build-and-pipeline-scan:
    permissions:
      contents: read
      security-events: write
      actions: read
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ''

      - run: zip -r veracode-scan-target.zip ./

      - run: curl --silent --show-error --fail -O https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip

      - run: unzip -o pipeline-scan-LATEST.zip

      - uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'

      - run: java -jar pipeline-scan.jar --veracode_api_id "${{secrets.VERACODE_API_ID}}" --veracode_api_key "${{secrets.VERACODE_API_KEY}}" --fail_on_severity="Very High, High" --file veracode-scan-target.zip
        continue-on-error: true

      - name: Convert pipeline scan output to SARIF format
        id: convert
        uses: veracode/veracode-pipeline-scan-results-to-sarif@ff08ae5b45d5384cb4679932f184c013d34da9be
        with:
          pipeline-results-json: results.json

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: veracode-results.sarif

      - name: Veracode Fix - Sugest√µes autom√°ticas de corre√ß√µes
        uses: veracode/veracode-fix@v1.0.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          inputFile: results.json

      - name: Criar issues a partir do results.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));

            if (!results.findings || results.findings.length === 0) {
              console.log("Nenhuma vulnerabilidade encontrada.");
              return;
            }

            for (const finding of results.findings.slice(0, 5)) {
              const file = finding.file;
              const severity = finding.severity;
              const cwe = finding.cwe?.name || 'CWE desconhecido';
              const description = finding.description || 'Sem descri√ß√£o dispon√≠vel.';
              const recommendation = finding.recommendation || 'Sem recomenda√ß√£o.';

              const issueTitle = `[${severity}] Vulnerabilidade detectada em ${file}`;
              const issueBody = `
**Arquivo:** \`${file}\`

**Gravidade:** ${severity}  
**Descri√ß√£o:** ${description}  
**CWE:** ${cwe}  
**Recomenda√ß√£o:** ${recommendation}

_Gerado automaticamente pelo Veracode Fix + GitHub Actions_
              `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
              });
            }
